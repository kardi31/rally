<script>
    $(document).ready(function(){
       $('.rallyButtons a').click(function(){
          $('.rallyButtons a.active').removeClass('active');
          $(this).addClass('active');
          $('.mainUserBox.active').hide();
          $('.mainUserBox.active').removeClass('active');
          $('#'+$(this).attr('rel')).show();
          $('#'+$(this).attr('rel')).addClass('active');
       });
    });

</script>
<?php $rally = $friendly['Rally']; ?>
<div class="mainUserBox showRallyWrapper">
    <h4 class="boxHeader"><?php echo $friendly['Rally']['name']; ?></h4> 
   
    <div class="showRallyBox <?php if(!$rally['finished']) echo "active"?> mainUserBox" id="details">
         <?php
            if(isset($message)){
                if(!$message['status'])
                    $this->showError($message['message']);
                else
                    $this->showSuccess($message['message']);
            }

            if(isset($_GET['msg'])){
                if($_GET['msg']=="user invited")
                    $this->showSuccess('User was succesfully invited.');
                if($_GET['msg']=="joined")
                    $this->showSuccess('You have joined this rally.');
            }
        ?>
        <span class="rallyDescription">
            <?= nl2br($friendly['description']); ?>
        </span>
        <hr />
        
        <?= $this->translate('Prize pool');?> : <?php echo $prizePool."$"; ?><br />
        <?= $this->translate('Signed crews');?> : <?php echo $crewCounter; ?><br />
        <?= $this->translate('Race start');?> : <?php echo $startDate->format('d/m/Y H:i'); ?><br />
        <?= $this->translate('Sign up finish');?> : <?php echo $signUpFinish->format('d/m/Y H:i'); ?><br />
        <?= $this->translate('Surface');?> : <?php
        foreach($rally['Surfaces'] as $key=>$surface):
          echo $surface['surface']." ".round($surface['percentage'])."%";  
            if($key==0)
                echo ", ";
        endforeach;
        ?>
        <br />
        <?= $this->translate('Rally type'); ?> :  <?php echo $friendly['invite_only']?"<span class='label label-danger'>Private</span>":"<span class='label label-success'>Public</span>"; ?><br />
        <?= $this->translate('Created by'); ?> : <?php echo $friendly['User']['username']; ?><br />
        
        <br />
        <?php if(isset($isParticipant)&&$isParticipant): ?>
            <span class="label label-success"><?= $this->translate('You already participate in this rally.'); ?></span>
        <?php endif; ?>
        <br />
        <?php if(isset($form)){ ?>
        
            <div class='goldCoinBox inviteFriendFriendly'>
                <strong><?= $this->translate('Invite your friend'); ?></strong>
                <form method="POST">
                    <br />
                    <div class='formElemWrapper'>
                        <?php echo $form->getElement('name')->renderElement(); ?>
                    </div>
                    <br />
                    <?php echo $form->getElement('submit')->renderElement(); ?>
                </form>
            </div>

<?php } ?>

<?php if(isset($joinForm)){ ?>
        <span class="label label-warning bigLabel"><?= $this->translate('You have been invited to this rally.'); ?></span>
        <br /><br />

        <div class="sign-up-rally">
            <h3>Sign up</h3>
            <form method="POST">
                <div class='formElemWrapper'>
                    <label for='driver_id' class="col-md-3 control-label" type='text'><?= $this->translate('Driver'); ?></label>
                    <?php echo $joinForm->getElement('driver_id')->renderElement(); ?>
                </div>
                <div class='formElemWrapper'>
                    <label for='pilot_id' class="col-md-3 control-label"  type='text'><?= $this->translate('Pilot'); ?></label>
                    <?php echo $joinForm->getElement('pilot_id')->renderElement(); ?>
                </div>     
                <div class='formElemWrapper'>
                    <label for='car_id' class="col-md-3 control-label"  type='text'><?= $this->translate('Car'); ?></label>
                    <?php echo $joinForm->getElement('car_id')->renderElement(); ?>
                </div>
                <div class='formElemWrapper'>
                    <label for='risk' class="col-md-3 control-label"  type='text'><?= $this->translate('Risk'); ?></label>
                    <?php echo $joinForm->getElement('risk')->renderElement(); ?>
                </div>
                <div class='goldCoinBox'>
                    <h4><?= $this->translate('Join friendly rally'); ?></h4>
                    <?php if(!$authenticatedUser['gold_member']): ?>
                        <div class="balance">
                            Balance: <?= (int)$authenticatedUser['premium']; ?><img class="coin" src="/images/layout/coin.png" /> <br />
                        </div>
                         Cost:  10<img class="coin" src="/images/layout/coin.png" />
                   <?php else: ?>
                        <?= $this->translate('You are a');?> <img src="/images/layout/gc_small.png" /> <?= $this->translate('member. You are allowed to create 2 friendly rallies every 30 days.');?>
                        <?php 
                        if($recentUserFriendlies['cnt']>=2){
                           $oldestFriendly = new DateTime($recentUserFriendlies['created_at']);
                           $oldestFriendly->add(new DateInterval('P30D'));
                           echo "<br/>".$this->translate('You have to wait until')."<strong>".$oldestFriendly->format('d/m/Y H:i')."</strong> ".$this->translate('to create another free friendly rally.'); 

                           ?>
                        <br />
                        <div class="balanceWrapper">
                            <div class="balance">
                                <?= $this->translate('Balance');?>: <?= (int)$authenticatedUser['premium']; ?><img class="coin" src="/images/layout/coin.png" /> <br />
                            </div>
                             <?= $this->translate('Cost'); ?>:  10<img class="coin" src="/images/layout/coin.png" />
                             <div class="clearfix"></div>
                        </div>
                        <?php
                        }
                        ;?>

                    <?php endif; ?>
                </div>
                <div class='formSubmitWrapper'>
                    <?php echo $joinForm->getElement('submit')->renderElement(); ?>
                </div>

            </form>
        </div>
        

<?php } ?>
    </div>
    <div class="showRallyBox mainUserBox" id="stages">
        <ul class="rallyStages">
            <?php foreach($rally['Stages'] as $key => $stage): ?>
            <li><?= $stage['name']." - ".$stage['length']; ?> km 
                <br /><i class="fa fa-clock-o"></i> 
                <?php 
                    echo TK_Text::timeFormat($stage['date'],"H:i"); 
                ?>
            <br /><br />
            </li>
            <?php endforeach; ?>
        </ul>
    </div>
    <?php if(!$rally['finished']){ ?>
        <div class="showRallyBox mainUserBox" id="invited">
            <?php

            if(!$friendly['invite_only']){
                echo $this->translate("This rally is open for all");
            }
            else{
                if(count($friendly['Invitations'] )==0)
                    echo $this->translate("No teams invited yet");
                ?>
                <table>
                    <?php foreach($friendly['Invitations'] as $key => $invited): ?>
                            <tr>
                                <td>
                                    <?= ($key+1)."."; ?>
                                </td>
                                <td>
                                    <?php echo $invited['User']['Team']['name']; ?>
                                </td>
                                <td>
                                    <?php echo $invited['User']['username']; ?>
                                </td>
                            </tr>
                    <?php endforeach; ?>

                    </table>
            <?php } ?>
        </div>
    <?php } ?>
    <div class="showRallyBox mainUserBox" id="crews">
        <table>
            <tr>
                <th></th>
                <th><?= $this->translate('Crew'); ?></th>
                <th><?= $this->translate('Car'); ?></th>
                <th><?= $this->translate('Team');?></th>
                <th><?= $this->translate('User'); ?></th>
            </tr>
            <?php foreach($rally['Crews'] as $key => $crew):?>
                    <tr>
                        <td>
                            <?= ($key+1)."."; ?>
                        </td>
                        <td>
                            <?php echo $crew['Driver']['last_name']." ".$crew['Driver']['first_name']; ?> - 
                            <?php echo $crew['Pilot']['last_name']." ".$crew['Pilot']['first_name']; ?>
                        </td>
                        <td>
                            <?php echo $crew['Car']['name']; ?>
                        </td>
                        <td>
                            <?php echo $crew['Team']['name']; ?>
                        </td>
                        <td>
                            <?php echo $crew['Team']['User']['username']; ?>
                        </td>
                    </tr>
            <?php endforeach; ?>

            </table>
    </div>
    <div class="showRallyBox mainUserBox" id="prizes">
        <?php if($rally['big_awards']): ?>
                <img src="/images/b_letter.gif" />
                <br />
                <?= $this->translate('Crew number'); ?> : <?php echo $crewCounter; ?><br />
                <h3><?= $this->translate('Prizes'); ?></h3>
                <?php 
                foreach($rallyPrizes as $key => $rallyPrize): 
                    $position = $key+1;
                    echo $this->translate("Position")." ".$position." - ";
                    if($rallyPrize['type']=="car"):
                        $car = $rallyPrize['value'];
                        ?>
                        <img src="/media/cars/<?php echo $car['photo']; ?>" alt="<?php echo $car['name']; ?>" />
                        <?php 
                    else:
                        echo $rallyPrize['value']." premium";
                    endif;
                    ?>
                        <br />
                        <?php
                endforeach; 
            else: ?>
                <h3><?= $this->translate('Prizes'); ?></h3>
                <?php 
                foreach($rallyPrizes as $position => $rallyPrize): 
                    echo $this->translate("Position")." ".$position." - ";
                    echo $rallyPrize."$ <br /><br />";
                endforeach; 
            endif; ?>
    </div>
    <div class="showRallyBox rallyResultWrapper mainUserBox <?php if($rally['finished']) echo "active"?>" id="result">
        <table>
                    <?php foreach($rallyResults as $result): ?>
                        <tr>
                            <td>
                                <?php if($result['out_of_race']==0){
                                    echo $result['position'];
                                }
                                ?>
                            </td>
                            <td>
                                <?php echo $result['Crew']['Team']['name']; ?>
                            </td>
                            <td>
                                <?php echo $result['Crew']['Driver']['last_name']." ".$result['Crew']['Driver']['first_name']; ?> - 
                                <?php echo $result['Crew']['Pilot']['last_name']." ".$result['Crew']['Pilot']['first_name']; ?>
                            </td>
                            <td>
                                 <?php if($result['out_of_race']==0){
                                    echo $result['total_time'];
                                }
                                else{
                                    echo $this->translate('Accident on stage no')." ".$result['stage_out_number'];
                                }
                                ?>
                            </td>
                        </tr>
                    <?php endforeach; ?>
                </table>
    </div>
    <div class="rallyButtons">
        <ul>
            
            <?php if($rally['finished']): ?>
                <li>
                    <a href="#" class="active" rel="result"><?= $this->translate('Results'); ?></a>
                </li>
            <?php endif ; ?>
            <li>
                <a class="<?php if(!$rally['finished']) echo "active"?>" rel="details" href="#"><?= $this->translate('Details'); ?></a>
            </li>
            <li>
                <a href="#" rel="stages"><?= $this->translate('Stages'); ?></a>
            </li>
            <?php if(!$rally['finished']){ ?>
                <li>
                    <a href="#" rel="invited"><?= $this->translate('Invited crews'); ?></a>
                </li>
            <?php } ?>
            <li>
                <a href="#" rel="crews"><?= $this->translate('Signed crews'); ?></a>
            </li>
            <li>
                <a href="#" rel="prizes"><?= $this->translate('Prize pool'); ?></a>
            </li>
        </ul>
    </div>
    
<!--<h3>Uczestnicy</h3>-->
<?php /*/* foreach($friendly['Participants'] as $participant): 
    if(is_null($participant['deleted_at'])){
        echo $participant['User']['username']."<br />";
    }
    endforeach; 
    // if rally has participants
    // and current user is a participant
    if(isset($participant)&&$participant&&$isParticipant){
        ?>
<a href="/rally/remove-friendly-rally-participant/slug/<?php echo $friendly['Rally']['slug'];?>">Wyrejestruj sie</a>
<?php
    }*/
    
    ?>

</div>
 <script>
  $(function() {
    $( "#name" ).autocomplete({
      source: function( request, response ) {
        $.ajax({
          url: "/user/find-user",
          dataType: "json",
          type: "get",
          data: {
            q: request.term
          },
          success: function( data ) {
            response( data );
          }
        });
      },
      minLength: 3
    });
  });
  </script>
